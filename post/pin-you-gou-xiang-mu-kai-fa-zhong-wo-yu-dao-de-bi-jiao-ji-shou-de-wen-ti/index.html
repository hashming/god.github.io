<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>品优购项目开发中我遇到的比较棘手的问题 | 阿鲤梨</title>
<meta name="description" content="Onepice" />
<link rel="shortcut icon" href="https://hashming.github.io/favicon.ico">
<link rel="stylesheet" href="https://hashming.github.io/styles/main.css">

<script src="https://hashming.github.io/media/js/jquery.min.js"></script>
<script src="https://hashming.github.io/media/js/masonry.pkgd.min.js"></script>
<script src="https://hashming.github.io/media/js/aos.js"></script>
<script src="https://hashming.github.io/media/js/pace.min.js"></script>
<script src="https://hashming.github.io/media/js/view-image.min.js"></script>
<script src="https://hashming.github.io/media/js/jquery.magnific-popup.min.js"></script>
<script src="https://hashming.github.io/media/js/functions.js"></script>
    <meta name="referrer" content="never">
    <meta name="description" content="1. 需求不明确困境
在项目开发中，项目采用迭代开发，开发需求不是很明确，对于项目开发初期来说非常困难，进度非常慢，有时开发的出的产品结果往往不能令老板满意，或者是甲方满意，项目还需要不停的迭代，修改。

比如说：
在开发品优购项目的时候，..." />
    <meta name="keywords" content="" />
    <script src="https://hashming.github.io/media/js/waterfall.min.js"></script>
    <script src="https://hashming.github.io/media/js/prism.min.js"></script>
  </head>
  <body>
            <header id="header" class="grid-container">
        <!-- start: .menu-wrapper -->
        <div class="menu-mobile"> 
          <i class="fa fa-reorder"></i>
        </div>
        <div class="menu-wrapper">
          <div class="">
            <div class="logo">
              <a href="https://hashming.github.io"><img src="" alt=""></a>
            </div>
            <!-- start: .main-nav -->

            <nav class="main-nav grid-container grid-parent">
              <ul id="menu-header" class="menu gradient-effect">
                <li class=""><a href="https://hashming.github.io" class="menu">首页</a></li>
                
                  <li class="" >
                    <a href="/" class="menu">
                      首页
                    </a>
                  </li>
                
                  <li class="" >
                    <a href="/archives" class="menu">
                      归档
                    </a>
                  </li>
                
                  <li class="" >
                    <a href="/tags" class="menu">
                      标签
                    </a>
                  </li>
                
                  <li class="" >
                    <a href="/post/about" class="menu">
                      关于
                    </a>
                  </li>
                
                <li class="search-menu-item hide-on-mobile hide-on-tablet"><a href="#search-lightbox" class="lightbox mfp-inline"><i class="fa fa-search-line"></i></a></li>
              </ul>
            </nav>
            <a href="#search-lightbox" class="lightbox epcl-search-button mfp-inline hide-on-tablet hide-on-desktop"><i class="fa fa-search-line"></i></a>
            <!-- end: .main-nav -->
            <div class="clear"></div>
            <div class="border hide-on-tablet hide-on-mobile"></div>
          </div>    
          <div class="clear"></div>
        </div>
        <!-- end: .menu-wrapper -->
        <div class="clear"></div>
      </header>
      <div class="hide-on-mobile hide-on-tablet hide-on-desktop">
        <div id="search-lightbox" class="grid-container grid-small grid-parent mfp-hide">
          <div class="search-wrapper section">
            <form id="gridea-search-form" data-update="1582882918867" action="/search/index.html" class="search-form" _lpchecked="1">
              <input type="text" name="q" id="s" value="" class="search-field" placeholder="搜点啥..." aria-label="搜点啥..." required="">
              <button type="submit" class="submit" aria-label="Submit">
                <i class="fa fa-search-line"></i>
              </button>
            </form>
          </div>
        </div>
      </div>

      <main id="single" class="main grid-container fullcover no-sidebar aos-init aos-animate" data-aos="fade">

        <div class="center content">
          <div class="featured-image cover" style="background-image: url('');">
            <div class="meta top"> 
              <time class="meta-info" style="float:left;" datetime="2020-02-28"><i class="fa fa-calendar"></i><span class="lately">3 小时前</span></time>
              
            </div>
            <div class="info">
              <div class="tags ">
                
              </div>
              <h1 class="title ularge white bold">品优购项目开发中我遇到的比较棘手的问题</h1>
            </div>
          </div>
        </div>  

        <div class="epcl-page-wrapper">
          <div class="left-content grid-70 np-mobile">
            <article class="main-article post">
              <section class="post-content">
                <div class="text">
                  <h1 id="1-需求不明确困境">1. 需求不明确困境</h1>
<p>在项目开发中，项目采用迭代开发，开发需求不是很明确，对于项目开发初期来说非常困难，进度非常慢，有时开发的出的产品结果往往不能令老板满意，或者是甲方满意，项目还需要不停的迭代，修改。</p>
<blockquote>
<p>比如说：<br>
在开发品优购项目的时候，客户定位是一个综合性的商务平台，可以实现在线第三方商家对接，实现商品的销售但是并没有明确的需求，因此开发全凭借电商的项目经验来实现里面的相关的业务，后期慢慢迭代。</p>
</blockquote>
<h1 id="2-使用-cas-单独登录不能很好实现想要的效果">2. 使用 cas 单独登录不能很好实现想要的效果</h1>
<h1 id="3-solr高亮不能显示">3. solr高亮不能显示</h1>
<p><strong>问题原因</strong>：angularJS 底层使用 ajax，异步加载高亮信息返回给页面后，页面没有刷新，就直接显示返回的数据。此时会把所有的数据作为普通的文本数据进行加载。因此就没有高亮的效果。<br>
<strong>解决方案</strong>：使用 angularJS 过滤器过滤文本数据，此时 angularJS 过滤器把 html 文本数据解析为浏览器能识别的 html 标签。高亮就能展示了。</p>
<h1 id="4-nginx-静态页面服务跳转到购物车跨域问题">4. Nginx 静态页面服务跳转到购物车跨域问题</h1>
<p>在 Nginx 中部署了静态页面，添加购物车时必须从静态页面跳转到购物车系统,实现购物车添加操作。由于在静态页面中使用 angularJS 实现的跳转，发现跳转到购物车系统完全没有问题，但是并不能跳转回到购物车系统页面。<br>
<strong>问题原因</strong>：从静态详情系统跳转到购物车系统，会存在跨域问题，因此不能进行回调函数的数据传递。所以在回调函数中的页面跳转就不能实现。<br>
<strong>解决方案</strong>：使用 angularJS 跨域调用及 springmvc 跨域配置，解决问题。</p>
<h1 id="5-activemq-存在运行时间长了以后收不到消息的现象时间长了就会出现卡死新的数据不能从队列接听到-只能重启程序">5. activeMQ 存在运行时间长了以后，收不到消息的现象时间长了就会出现，卡死，新的数据不能从队列接听到。只能重启程序。</h1>
<p><strong>解决方案</strong>：🤗</p>
<ol>
<li>不要频繁的建立和关闭连接</li>
</ol>
<blockquote>
<p>JMS 使用长连接方式，一个程序，只要和 JMS 服务器保持一个连接就可以了，不要频繁的建立和关闭连接。频繁的建立和关闭连接，对程序的性能影响还是很大的。这一点和 jdbc 还是不太一样的。</p>
</blockquote>
<ol start="2">
<li>Connection 的 start()和 stop()方法代价很高</li>
</ol>
<blockquote>
<p>JMS 的 Connection 的 start()和 stop()方法代价很高，不能经常调用。我们试用的时候，写了个 jms 的 connection pool，每次将 connection 取出 pool 时调用 start()方法，归还时调用 stop()方法，然而后来用 jprofiler发现，一般的 cpu 时间都耗在了这两个方法上。</p>
</blockquote>
<ol start="3">
<li>start()后才能收消息</li>
</ol>
<blockquote>
<p>Connection 的 start()方法调用后，才能收到 jms 消息。如果不调用这个方法，能发出消息，但是一直收不到消息。不知道其它的 jms 服务器也是这样</p>
</blockquote>
<ol start="4">
<li>显式关闭 Session</li>
</ol>
<blockquote>
<p>如果忘记了最后关闭 Connection 或 Session 对象，都会导致内存泄漏。这个在我测试的时候也发现了。本来以为关闭了 Connection，由这个Connection 生成的 Session 也会被自动关闭，结果并非如此，Session 并没有关闭，导致内存泄漏。所以一定要显式的关闭 Connection 和 Session。</p>
</blockquote>
<ol start="5">
<li>对 Session 做对象池</li>
</ol>
<blockquote>
<p>对 Session 做对象池，而不是 Connection。Session 也是昂贵的对象，每次使用都新建和关闭，代价也非常高。而且后来我们发现，原来 Connection是线程安全的，而 Session 不是，所以后来改成了对 Session 做对象池，而只保留一个 Connection。</p>
</blockquote>
<ol start="6">
<li>集群</li>
</ol>
<blockquote>
<p>ActiveMQ 有强大而灵活的集群功能，但是使用起来还是会有很多陷阱</p>
</blockquote>
<h1 id="6-activemq-存在发生消息太大造成消息接受不成功">6. activeMQ 存在发生消息太大，造成消息接受不成功</h1>
<p>多个线程从 activeMQ 中取消息，随着业务的扩大，该机器占用的网络带宽越来越高。仔细分析发现，mq 入队时并没有异常高的网络流量，仅仅在出队时会产生很高的网络流量。<br>
<strong>问题原因</strong>：<br>
<strong>最终发现是 spring的 的 jmsTemplate与 与 activemq的 的 prefetch 机制配合导致的问题</strong><br>
<em>研究源码发现 jmsTemplate实现机制是：每次调用 receive()时都会创建一个新的consumer 对象，用完即销毁。</em><br>
正常情况下仅仅会浪费重复创建 consumer 的资源代价，并不至于产生正常情况十倍百倍的网络流量。但是 activeMQ 有一个提高性能的机制 prefetch，此时就会有严重的问题。<br>
<strong>prefetch 机制:</strong><br>
每次 consumer 连接至 MQ 时，MQ 预先存放许多message 到消费者（前提是 MQ 中存在大量消息），预先存 放message的数量取决于prefetchSize（默认为 1000）。此机制的目的很显然，是想让客户端代码用一个 consumer 反复进行 receive操作，这样能够大量提高出队性能。此机制与jmsTemplate 配合时就会产生严重的问题，每次 jmsTemplate.receive()，都会产生 1000个消息的网络流量， 但是因为jmsTemplae并不会重用 consumer，导致后面 999 个消息都被废弃。反复jmsTemplate.receive()时，表面上看 不出任何问题，其实网络带宽会造成大量的浪费。<br>
<strong>解决方案</strong>：</p>
<ol>
<li>若坚持使用 jmsTemplate，需要设置prefetch值为 1，相当于禁用了 activeMQ 的prefetch 机制，此时感觉最健壮， 就算多线程，反复调用 jmsTemplate.receive()也不会有任何问题。但是会有资源浪费，因为要反复创建 consumer 并频繁与服务器进 行数据通信，但在性能要求不高的应用中也不算什么问题。</li>
<li>不使用 jmsTemplate，手工创建一个consumer，并单线程反复使用它来 receive()，此时可以充分利用 prefetch 机制。配合多线程的方式每个线程拥有自己的一个 consumer，此时能够充分发挥 MQ在大吞吐量时的速度优势。</li>
</ol>
<p>切记避免多线程使用一个 consumer 造成的消息混乱。大吞吐量的应用推荐使用方案 2，能够充分利用<br>
prefetch 机制提高系 MQ 的吞吐性能。</p>

                </div>
                <div class="clear"></div>
              </section>
            </article>
            <div class="clear"></div>

            <section class="related section">
              
              
              <article class="next grid-50 tablet-grid-50 grid-parent">
                <div class="thumb cover lazy loaded" style="background-image: url('https://hashming.github.io/media/images/gridea.jpg');"></div>
                 <a href="https://hashming.github.io/post/springmvc-zhi-jia-gou-yu-gong-zuo-liu-cheng" class="full-link"></a>
                 <div class="info">
                  <time datetime="2020-02-28">2020-02-28</time>
                  <h4 class="title white no-margin">SpringMVC之架构与工作流程</h4>
                </div>
                 <span class="epcl-button red">
                  <img src="https://hashming.github.io/media/images/right-arrow.svg" width="15" alt="Left Arrow">
                </span>
                <div class="overlay"></div>
              </article>
              

                <div class="clear"></div>
            </section>

              <div class="clear"></div>
              
            
              <div id="comments" class="bg-white hosted ">
                
                  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<div id="gitalk-container"></div>
<div class="clear"></div>

<script>
  var gitalk = new Gitalk({
    clientID: '6171618e488c4622fa3c',
    clientSecret: '0a2e1332ffba9746b8f128c9faecb49862d09086',
    repo: 'hashming.github.io',
    owner: 'hashming',
    admin: ['hashming'],
    id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
    distractionFreeMode: false  // Facebook-like distraction free mode
  })

  gitalk.render('gitalk-container')
</script>

                
                
              </div>
            

            </div>
          </div>
      </main>

          <footer id="footer" class="grid-container">
        <div class="widgets row gradient-effect">
            <div class="default-sidebar border-effect">
              <div class="grid-33 tablet-grid-50 mobile-grid-100">
                <section id="tag_cloud-2" class="widget widget_epcl_posts_thumbs underline-effect">
                  <h4 class="widget-title title white bordered">最新文章</h4>
                  
                  
                  <article class="item post-0 post type-post status-publish format-standard has-post-thumbnail hentry">
                    <a href="https://hashming.github.io/post/pin-you-gou-xiang-mu-kai-fa-zhong-wo-yu-dao-de-bi-jiao-ji-shou-de-wen-ti" class="thumb hover-effect">
                      <span class="fullimage cover" style="display:block;border-radius:50%;background-image: url('');"></span>
                    </a>
                    <div class="info gradient-effect">
                      <time datetime="2020-02-28">2020-02-28</time>
                      <h4 class="title usmall">
                        <a href="https://hashming.github.io/post/pin-you-gou-xiang-mu-kai-fa-zhong-wo-yu-dao-de-bi-jiao-ji-shou-de-wen-ti">品优购项目开发中我遇到的比较棘手的问题</a>
                      </h4>
                    </div>
                    <div class="clear"></div>
                  </article>
                  
                  
                  
                  <article class="item post-1 post type-post status-publish format-standard has-post-thumbnail hentry">
                    <a href="https://hashming.github.io/post/springmvc-zhi-jia-gou-yu-gong-zuo-liu-cheng" class="thumb hover-effect">
                      <span class="fullimage cover" style="display:block;border-radius:50%;background-image: url('');"></span>
                    </a>
                    <div class="info gradient-effect">
                      <time datetime="2020-02-28">2020-02-28</time>
                      <h4 class="title usmall">
                        <a href="https://hashming.github.io/post/springmvc-zhi-jia-gou-yu-gong-zuo-liu-cheng">SpringMVC之架构与工作流程</a>
                      </h4>
                    </div>
                    <div class="clear"></div>
                  </article>
                  
                  
                  
                  <article class="item post-2 post type-post status-publish format-standard has-post-thumbnail hentry">
                    <a href="https://hashming.github.io/post/jdbc-zhong-de-sql-zhu-ru-gong-ji-fang-fan" class="thumb hover-effect">
                      <span class="fullimage cover" style="display:block;border-radius:50%;background-image: url('');"></span>
                    </a>
                    <div class="info gradient-effect">
                      <time datetime="2019-12-31">2019-12-31</time>
                      <h4 class="title usmall">
                        <a href="https://hashming.github.io/post/jdbc-zhong-de-sql-zhu-ru-gong-ji-fang-fan">jdbc中的sql注入攻击防范</a>
                      </h4>
                    </div>
                    <div class="clear"></div>
                  </article>
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  <div class="clear"></div>
                </section>
              </div>

              <div class="grid-33 tablet-grid-50 mobile-grid-100">
                <section id="tag_cloud-2" class="widget widget_tag_cloud underline-effect">
                  <h4 class="widget-title title white bordered">标签云</h4>
                  <div class="tagcloud">
                    
                  </div>
                  <div class="clear"></div>
                </section>
              </div>

              <div class="grid-33 tablet-grid-50 mobile-grid-100">
                <section id="epcl_about-2" class="widget widget_epcl_about underline-effect">
                  <h4 class="widget-title title white bordered">关于我</h4>
                  <div class="avatar">
                    <a href="" class="translate-effect thumb"><span class="fullimage cover" style="background-image: url(https://hashming.github.io/images/avatar.png);"></span></a>
                  </div>
                  <div class="info">
                    <h4 class="title small author-name gradient-effect no-margin"><a href="">阿鲤梨</a></h4>
                    <p class="founder">Onepice</p>
                    <div class="social">
                      
                        
                      
                        
                      
                        
                      
                        
                      
                        
                      
                    </div> 
                  </div>
                  <div class="clear"></div>
                  </section>
              </div>

            </div>
            <div class="clear"></div>
        </div>

        <div class="logo">
          <a href="https://hashming.github.io"><img src="" alt=""></a>
        </div>
        <p class="published border-effect">
          ©2019 共 8 篇文章
          <br/>
          Theme <a href="https://gridea.dev/" target="_blank">「breek」</a> Powered by <a href="https://gridea.dev/" target="_blank">「Gridea」</a>
        </p>
        
        <a href="javascript:void(0)" id="back-to-top" class="epcl-button dark" style="display:none">
          <i class="fa fa-arrow"></i>
        </a>
    </footer>
    
    <div class="clear"></div>

        

      
    <script src="https://hashming.github.io/media/js/functions-post.js"></script>

    </div>
    <!-- end: #wrapper -->
  </body>
</html>
